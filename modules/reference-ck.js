/*globals Backbone javascripture, bible, worker, _ */var WordModel=Backbone.Model.extend({}),WordView=Backbone.View.extend({model:WordModel,tagName:"span",template:_.template($("#word-template").html()),render:function(e,t,n,r){var i=this,s="",o=[];lemma=e[1];if(lemma){lemmaArray=lemma.split(" ");lemmaArray.forEach(function(e,t){o.push(javascripture.api.word.getFamily(e))})}wordDisplay=e[0];r==="lc"&&t==="english"&&(wordDisplay+=javascripture.modules.translateLiterally.getWord(e));var u="",a="";if(o.length>0){u=o.join(" ")+"-family";a+=o.join(" ")+"-family"}lemma&&(a+=" "+lemma);return this.template({className:a,families:u,lemma:this.model.get("lemma"),morph:e[2],word:e[0],wordDisplay:wordDisplay,testament:n,range:"verse"})}});javascripture.modules.reference={wordTemplate:_.template($("#word-template").html()),verseTemplate:_.template($("#verse-template").html()),chapterTemplate:_.template($("#chapter-template").html()),load:function(e){var t=this,n=e.book,r=e.chapter,i=e.verse;"undefined"==typeof i&&(e.verse=1);e.rightVersion=$("#versionSelectorRight").val();if(e.rightVersion==="original"){e.rightVersion="kjv";localStorage.rightVersion&&(e.rightVersion=localStorage.rightVersion)}e.leftVersion=$("#versionSelectorLeft").val();if(e.leftVersion==="original"){e.leftVersion="kjv";localStorage.leftVersion&&(e.leftVersion=localStorage.leftVersion)}worker.postMessage({task:"reference",parameters:e});return this},scrollToVerse:function(e,t){undefined===t&&(t=0);$(document).scrollTop(0);t-=$("#dock").height();$("html").hasClass("reading-mode")&&(t-=50);e.length>0&&$(document).scrollTo(e,{offset:t});$(document).trigger("createWayPoint")},getAnchoringData:function(e){var t="#current",n=0,r=$(document).scrollTop(),i;if(e){e==="prev"&&(i=$(".reference:first-child ol.wrapper li:first-child"));e==="next"&&(i=$(".reference:last-child ol.wrapper li:last-child"));t="#"+i.attr("id");n=r-i.offset().top+$("#dock").height()}return[n,t]},anchorReference:function(e){var t=e[1],n=e[0],r=$(t),i;t===".current-verse"&&(i=r.height(),n=-$(window).height()/2+i);if(r.length===0){r=$("#"+e.currentId);n=-$("[data-role=header]").height()}this.scrollToVerse(r,n)},getReferenceFromCurrentUrl:function(){return this.getReferenceFromUrl(window.location.hash)},getReferenceFromUrl:function(e){var t=e.split("&"),n={};if(t.length>1){n.book=t[0].split("=")[1],n.chapter=parseInt(t[1].split("=")[1],10),n.verse=1;t[2]&&(n.verse=parseInt(t[2].split("=")[1],10))}return n},loadReferenceFromHash:function(){var e=window.location.hash;if(e.indexOf("search")>-1){var t=e.split("=")[1];setTimeout(function(){createSearchReferencesPanel({lemma:t})})}else if(e.indexOf("reference")>-1){var n=this.getReferenceFromHash();localStorage&&(localStorage.reference=JSON.stringify(n));n.anchoringData=javascripture.modules.reference.getAnchoringData(null);javascripture.modules.reference.load(n)}},getReferenceFromHash:function(){var e=window.location.hash.split("=")[1].split(":"),t=e[0],n=parseInt(e[1],10),r=1;e[2]&&(r=parseInt(e[2],10));return{book:t,chapter:n,verse:r}},createReferenceLink:function(e){return"reference="+e.book+":"+e.chapter+":"+e.verse},getChapterText:function(e,t,n){var r=this,i=e.book,s=e.chapter,o=e.verse,u=s-1,a=o-1,f=!1,l="";t&&t.right&&t.right.forEach(function(i,s){l+=r.getVerseString(e,t,i,s,a,n)});return this.chapterTemplate({book:i,chapter:s,verses:l})},getVerseString:function(e,t,n,r,i,s){var o=this,u="",a="",f="",l="";r===i&&(u="current");r===i&&(a="current");if(r===i-5){a="context";context=!0}e.rightVersion==="lc"?t.left[r].forEach(function(t,n){t&&(f+=o.createWordString(t,"english",s,e.rightVersion))}):t.right[r].forEach(function(t,n){t&&(f+=o.createWordString(t,"english",s,e.rightVersion))});t.left[r]&&t.left[r].forEach(function(e,t){e&&(l+=o.createWordString(e,s,s))});return this.verseTemplate({verseId:e.book.replace(/ /gi,"_")+"_"+e.chapter+"_"+(r+1),wrapperId:a,className:u,verseNumber:r,rightString:f,testament:s,leftString:l})},createWordString:function(e,t,n,r){var i=new WordModel({word:e[0],lemma:e[1],morph:e[2]}),s=new WordView({model:i});return s.render(e,t,n,r)}};(function(e){var t=javascripture.data.english;e.fn.scrollStopped=function(t){e(this).scroll(function(){var n=this,r=e(n);r.data("scrollTimeout")&&clearTimeout(r.data("scrollTimeout"));r.data("scrollTimeout",setTimeout(t,250,n))})};javascripture.modules.reference.loadReferenceFromHash();e(window).bind("hashchange",function(){startDate=new Date;javascripture.modules.reference.loadReferenceFromHash()});e(window).scrollStopped(function(){var t=e(document).scrollTop(),n=e(".referencePanel").height()-e(window).height(),r;if(t<=0){var i=e(".three-references").data("prev");if(i){i.anchoringData=javascripture.modules.reference.getAnchoringData("prev");javascripture.modules.reference.load(i)}}if(t>=n){var s=e(".three-references").data("next");if(s){s.anchoringData=javascripture.modules.reference.getAnchoringData("next");javascripture.modules.reference.load(s)}}});e(".goToReference").submit(function(t){t.preventDefault();var n=bible.parseReference(e("#goToReference").val()),r={book:bible.Data.books[n.bookID-1][0],chapter:n.chapter,verse:n.verse},i=javascripture.modules.reference.createReferenceLink(r);window.location.hash=i;e(this).closest(".popup").popup("close");e("#goToReference").blur();e("html").hasClass("reading-mode")&&hideDock();return!1});worker.addEventListener("message",function(t){if(t.data.task==="reference"){var n=t.data.result.reference,r='<div class="three-references"';t.data.result.prev&&(r+=" data-prev='"+JSON.stringify(t.data.result.prev)+"'");t.data.result.next&&(r+=" data-next='"+JSON.stringify(t.data.result.next)+"'");r+=">";if(t.data.result.prev){r+=javascripture.modules.reference.getChapterText(t.data.result.prev,t.data.result.chapters[0],t.data.result.testament);r+=javascripture.modules.reference.getChapterText(n,t.data.result.chapters[1],t.data.result.testament);t.data.result.next&&(r+=javascripture.modules.reference.getChapterText(t.data.result.next,t.data.result.chapters[2],t.data.result.testament))}else{r+=javascripture.modules.reference.getChapterText(n,t.data.result.chapters[0],t.data.result.testament);t.data.result.next&&(r+=javascripture.modules.reference.getChapterText(t.data.result.next,t.data.result.chapters[1],t.data.result.testament))}r+="</div>";e("#verse").html(r);var i=n.book;typeof n.chapter!="undefined"&&(i+=" "+n.chapter);typeof n.verse!="undefined"&&(i+=":"+n.verse);e("head title").text(i);e.fn.waypoint&&e(".reference").waypoint("destroy");javascripture.modules.reference.anchorReference(t.data.parameters.anchoringData);maintainState(n);var s=new Date;timer(startDate,s)}});worker.addEventListener("message",function(t){t.data.task==="loading"&&e(".loading").html(t.data.html)})})(jQuery);