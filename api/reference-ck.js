/*globals javascripture*/function getChapterText(e){var t=e.book,n=e.chapter,r=e.verse,i=n-1,s=r-1,o=!1,u='<div class="reference frequencyAnalysis" data-book="'+t+'" data-chapter="'+n+'"><h1>'+t+" "+n+"</h1>";u+='<ol class="wrapper">';var a,f;if(javascripture.data.hebrew[t]){a=javascripture.data.hebrew;testament="hebrew"}else{a=javascripture.data.greek;testament="greek"}javascripture.data.english[t][i]&&$.each(javascripture.data.english[t][i],function(e,r){u+='<li id="'+t.replace(/ /gi,"_")+"_"+n+"_"+(e+1)+'"';e===s&&(u+=' class="current"');u+='data-verse="'+(e+1)+'">';u+='<div class="wrapper"';e===s&&(u+=' id="current"');if(e===s-5){u+=' id="context"';o=!0}u+=">";u+='<div class="english">';javascripture.modules.versionSelector.getVersion()==="lc"?$.each(a[t][i][e],function(e,t){t&&(u+=createWordString(t,"english",testament))}):$.each(javascripture.data.english[t][i][e],function(e,t){t&&(u+=createWordString(t,"english",testament))});u+="</div>";if(a[t]&&a[t][i][e]){u+="<div class='original "+testament+"'>";$.each(a[t][i][e],function(e,t){t&&(u+=createWordString(t,testament,testament))});u+="</div>"}u+="</div>";u+="</li>"});u+="</ol>";u+="</div>";return u}function createWordString(e,t,n){var r=this,i="",s=[];if(typeof e[1]=="undefined")return"<span>"+e[0]+"</span> ";lemma=e[1];if(lemma){lemmaArray=lemma.split(" ");$.each(lemmaArray,function(e,t){s.push(javascripture.modules.reference.getFamily(t))})}i+="<span";i+=' class="'+s.join(" ")+'"';i+=' title="'+lemma;e[2]&&(i+=" "+e[2]);i+='"';i+=' data-word="'+e[0]+'"';i+=' data-lemma="'+e[1]+'"';i+=' data-language="'+n+'"';i+=' data-range="verse"';i+=' data-family="'+s.join(" ")+'"';e[2]&&(i+=' data-morph="'+e[2]+'"');i+=">";javascripture.modules.versionSelector.getVersion()==="lc"&&t==="english"?i+=javascripture.modules.translateLiterally.getWord(e):i+=e[0];i+="</span> ";return i}function getOffsetChapter(e,t){var n=e.book,r=e.chapter,i={},s=parseInt(r,10)+t,o=s-1,u;if(javascripture.data.english[n]&&javascripture.data.english[n][o]!==undefined){i.book=n;i.chapter=s}else $.each(bible.Data.books,function(e,r){if(r[0]===n){u=e+t;if(bible.Data.books[u]!==undefined){i.book=bible.Data.books[u][0];t>0?i.chapter=1:i.chapter=bible.Data.verses[u].length}}});return i}javascripture.modules.reference={load:function(e){var t=e.book,n=e.chapter,r=e.verse;"undefined"==typeof r&&(e.verse=1);var i=t;typeof n!="undefined"&&(i+=" "+n);typeof r!="undefined"&&(i+=":"+r);$("head title").text(i);var s=$('<div class="three-references" />'),o=getOffsetChapter(e,-1),u=getOffsetChapter(e,1);if(o.book){s.data("prev",o);s.append(getChapterText(o))}s.append(getChapterText(e));if(u.book){s.data("next",u);s.append(getChapterText(u))}$.fn.waypoint&&$(".reference").waypoint("destroy");$("#verse").html(s);maintainState(t,n,r);return this},scrollToVerse:function(e,t){undefined===t&&(t=0);$(document).scrollTop(0);t-=$(".dock").height();$("html").hasClass("reading-mode")&&(t-=50);e.length>0&&$(document).scrollTo(e,{offset:t});$(document).trigger("createWayPoint")},getAnchoringData:function(e){var t="#current",n=0,r=$(document).scrollTop(),i;if(e){e==="prev"&&(i=$(".reference:first-child ol.wrapper li:first-child"));e==="next"&&(i=$(".reference:last-child ol.wrapper li:last-child"));t="#"+i.attr("id");n=r-i.offset().top+$(".dock").height()}return[n,t]},anchorReference:function(e){var t=e[1],n=e[0],r=$(t);t===".current-verse"&&(verseHeight=r.height(),n=-$(window).height()/2+verseHeight);if(r.length===0){r=$("#"+jsonCollection.currentId);n=-$("[data-role=header]").height()}this.scrollToVerse(r,n)},getFamily:function(e){return javascripture.data.strongsObjectWithFamilies[e]?javascripture.data.strongsObjectWithFamilies[e].family:e},getReferenceFromUrl:function(){var e=window.location.hash.split("&"),t={};if(e.length>1){t.book=e[0].split("=")[1],t.chapter=parseInt(e[1].split("=")[1],10),t.verse=1;e[2]&&(t.verse=parseInt(e[2].split("=")[1],10))}return t},loadReferenceFromHash:function(){var e=window.location.hash;if(e.indexOf("search")>-1){var t=e.split("=")[1];setTimeout(function(){createSearchReferencesPanel({lemma:t})})}else{var n=e.split("&");if(n.length>1){var r=n[0].split("=")[1],i=parseInt(n[1].split("=")[1],10),s=1;n[2]&&(s=parseInt(n[2].split("=")[1],10));localStorage&&(localStorage.reference=[r,i,s]);javascripture.modules.reference.load({book:r,chapter:i,verse:s}).scrollToVerse($("#current"))}}}};